{% extends "base.html" %}
{% set page = 'settings' %}
{% block head %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/element-plus"></script>
<style>
    .form-row {
        margin-bottom: 24px;
        display: flex;
        align-items: center;
    }
    .form-label {
        width: 100px;
        min-width: 80px;
        font-weight: bold;
        margin-right: 12px;
        text-align: right;
    }
    .form-input { 
        width: 360px; 
        padding: 8px; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
    }
    .btns { margin-top: 32px; }
    .input-group {
        display: flex;
        align-items: center;
        position: relative;
        width: 360px;
    }
    .eye-icon {
        margin-left: -32px;
        z-index: 2;
        background: #fff;
        border-radius: 4px;
        padding: 2px 4px;
        cursor: pointer;
        font-size: 18px;
        user-select: none;
        color: #888;
        transition: background 0.2s;
    }
    .eye-icon:hover { background: #f0f0f0; color: #409EFF; }
    .btn {
        padding: 6px 16px;
        border: none;
        border-radius: 4px;
        background: #409EFF;
        color: #fff;
        cursor: pointer;
        margin-right: 8px;
        font-size: 14px;
        transition: background 0.2s;
    }
    .btn:hover { background: #337ecc; }
</style>
{% endblock %}
{% block content %}
{% raw %}
<div id="app">
    <h2>ç³»ç»Ÿè®¾ç½®</h2>
    
    <div class="form-row">
        <label class="form-label">API åœ°å€:</label>
        <input v-model="api_base" class="form-input" placeholder="è¯·è¾“å…¥APIåœ°å€" />
    </div>
    
    <div class="form-row">
        <label class="form-label">API Key:</label>
        <div class="input-group">
            <input v-model="api_key" :type="showKey ? 'text' : 'password'" class="form-input" placeholder="è¯·è¾“å…¥APIå¯†é’¥" />
            <span class="eye-icon" @click="showKey = !showKey">
                {{ showKey ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}
            </span>
        </div>
    </div>
    
    <div class="form-row">
        <label class="form-label">Model åç§°:</label>
        <input v-model="model_name" class="form-input" placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°" />
    </div>
    
    <div class="btns">
        <button class="btn" @click="testConn" :disabled="loading">æµ‹è¯•è¿æ¥</button>
        <button class="btn" @click="save" :disabled="loading">ä¿å­˜è®¾ç½®</button>
    </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue

createApp({
    setup() {
        const api_base = ref('')
        const api_key = ref('')
        const model_name = ref('')
        const loading = ref(false)
        const showKey = ref(false)

        const fetchSettings = async () => {
            try {
                const resp = await fetch('/api/settings')
                const data = await resp.json()
                if (data.status === 'success') {
                    api_base.value = data.data.api_base || ''
                    api_key.value = data.data.api_key || ''
                    model_name.value = data.data.model_name || ''
                }
            } catch (error) {
                console.error('è·å–è®¾ç½®å¤±è´¥:', error)
                ElementPlus.ElMessage.error('è·å–è®¾ç½®å¤±è´¥')
            }
        }

        const save = async () => {
            loading.value = true
            try {
                const resp = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_base: api_base.value,
                        api_key: api_key.value,
                        model_name: model_name.value
                    })
                })
                const data = await resp.json()
                if (data.status === 'success') {
                    ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸ')
                } else {
                    ElementPlus.ElMessage.error(data.message || 'ä¿å­˜å¤±è´¥')
                }
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error)
                ElementPlus.ElMessage.error('ä¿å­˜è®¾ç½®å¤±è´¥')
            } finally {
                loading.value = false
            }
        }

        const testConn = async () => {
            loading.value = true
            try {
                const resp = await fetch('/api/settings/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_base: api_base.value,
                        api_key: api_key.value,
                        model_name: model_name.value
                    })
                })
                const data = await resp.json()
                if (data.status === 'success') {
                    ElementPlus.ElMessage.success('è¿æ¥æˆåŠŸ')
                } else {
                    ElementPlus.ElMessage.error(data.message || 'è¿æ¥å¤±è´¥')
                }
            } catch (error) {
                console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error)
                ElementPlus.ElMessage.error('æµ‹è¯•è¿æ¥å¤±è´¥')
            } finally {
                loading.value = false
            }
        }

        onMounted(() => {
            fetchSettings()
        })

        return {
            api_base,
            api_key,
            model_name,
            loading,
            showKey,
            save,
            testConn
        }
    }
}).use(ElementPlus).mount('#app')
</script>
{% endraw %}
{% endblock %} 